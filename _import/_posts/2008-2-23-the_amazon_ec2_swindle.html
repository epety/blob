--- 
layout: post
title: Amazon EC2 Is Half As Fast As It Should Be
mt_id: 13
---
<b>Update:</b> This post is made of fail.&nbsp; I trusted other peoples' benchmarks instead of doing my own.&nbsp; If you want details, go read <a href="http://blogs.smugmug.com/don/2008/02/27/ec2-isnt-50-slower/">Don MacAskill's butthurt response</a> on the SmugMug blog.<br /><br />The fun part about running a virtualized server environment on a heterogeneous hardware setup is that you can play word games with the specifications.&nbsp; Let's take, oh, I don't know, Amazon EC2 for example.&nbsp; This article is going to be all "science", but the takeaway is this: <b>in Amazon's EC2 environment, you only get half of the CPU performance you would expect.</b><br /><br />When EC2 launched, the specifications for the machine were "the equivalent of a 1.7GHz x86 processor".&nbsp; Crappy by the day's standards, but only a dime per hour.&nbsp; Fine.<br /><br />As EC2 developed, Amazon came up with the idea of the "Compute Unit" to describe the power you get out of the instances.&nbsp; From the documentation:<br /><i><br /></i><blockquote><i><span class="small">One EC2 Compute Unit provides the equivalent CPU
capacity of a 1.0-1.2 GHz 2007 Opteron or 2007 Xeon processor. This is
also the equivalent to an early-2006 1.7 GHz Xeon processor referenced
in our original documentation.</span></i><br /><i><span class="small"></span></i></blockquote><i><span class="small"></span></i><span class="small">I won't get nitpicky about how they think that 2006 megahertz are slower than 2007 megahertz; I just want to show how nebulous the specification is. <br /><font style="font-size: 1.25em;"><b><br />Processes Run Half As Fast As You Think They Should</b></font><br /><br />I figured this little nugget out last week.&nbsp; I had failed a piece of code to the point where an infinite loop would happen in an edge case.&nbsp; It took a while to debug this because looking at <code>top</code> in the EC2 instance only showed 40-50% CPU usage.<br /><br />At the same time, I noticed another metric, the CPU <code>%st</code>, hovering around 50%.&nbsp; This stands for "CPU time stolen", and you'll notice that as your CPU usage rises, so does steal-time.&nbsp; What exactly does "stolen" mean?&nbsp; <i>Time is stolen when your instance requests CPU time but the Xen virtualizer chooses to give that CPU time to something else, such as somebody else's instance.</i><br /><br />I am not the only one to notice this, either.&nbsp; <a href="http://developer.amazonwebservices.com/connect/thread.jspa?messageID=56568&amp;">There</a> <a href="http://developer.amazonwebservices.com/connect/message.jspa?messageID=60958">are</a> <a href="http://developer.amazonwebservices.com/connect/thread.jspa?threadID=16912">threads</a> on the AWS forums by other users who are seeing their code run half as fast as it should, given the specifications for a Compute Unit.&nbsp; These posts are met by dismissive replies from Amazon employees.&nbsp; Great job.<br /><font style="font-size: 1.25em;"><b><br />How They Can Get Away With This</b></font><br /><br />I think that many EC2 users are more I/O bound than CPU bound.&nbsp; If you make a simple Rails app backed by MySQL, chances are you're not going to consistently burn the CPU, so you won't even notice the slowdown.&nbsp; However, if you have some work that <i>is</i> CPU bound, this restriction becomes painfully obvious.<br /><br />They also get to mince words with the <i>equivalent-to</i> metric.&nbsp; You don't actually get 1.7 billion clock cycles per second.&nbsp; This comparison is made by considering the machine as a whole: disk controller speed, memory bus speed, and evidently to a much lesser extent, CPU speed.<br /><br />After doing Uncov, it's hard for me to tell the difference between a swindle and incompetence.<br /></span>  
